name: Continuous Deployment
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Ensure Namespaces Exist
        run: |
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
          kubectl create namespace devops-lab --dry-run=client -o yaml | kubectl apply -f -
          
      - name: Deploy Monitoring Stack (Prometheus/Grafana)
        run: |
          helm repo add prometheus-community prometheus-community.github.io || true
          helm repo update
          helm upgrade --install monitoring prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --set grafana.service.type=NodePort \
            --set grafana.service.nodePort=32000 \
            --wait --timeout 5m

      - name: Deploy Database (PostgreSQL)
        run: |
          helm upgrade --install my-db oci://registry-1.docker.io/bitnamicharts/postgresql \
            --namespace devops-lab \
            --set auth.database=student_db \
            --set auth.postgresPassword=devops_password \
            --wait

      - name: Deploy Infrastructure (App & Web)
        run: |
          # Apply base deployments from your k8s folder
          kubectl apply -f k8s/app-deployment.yaml
          kubectl apply -f k8s/web-deployment.yaml
          
          # Ensure services exist and are linked correctly
          kubectl expose deployment app-server --port=8080 --name=app-server -n devops-lab --dry-run=client -o yaml | kubectl apply -f -
          
          # Setup Web Service with fixed NodePort 30088
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: web-service
            namespace: devops-lab
          spec:
            type: NodePort
            selector:
              app: web-server
            ports:
              - protocol: TCP
                port: 80
                targetPort: 80
                nodePort: 30088
          EOF

      - name: SRE Fix: Inject PostgreSQL JDBC Driver
        run: |
          # 1. Download the actual binary JAR file (approx 1MB)
          curl -L -o postgresql.jar jdbc.postgresql.org
          
          # 2. Loop through all app pods and copy the driver to the Tomcat lib folder
          # This ensures the 'org.postgresql.Driver' error is resolved
          for pod in $(kubectl get pods -n devops-lab -l app=app-server -o jsonpath='{.items[*].metadata.name}'); do
            echo "Injecting driver into $pod..."
            kubectl cp postgresql.jar devops-lab/$pod:/usr/local/tomcat/lib/
          done

      - name: Inject Application Logic (JSP & HTML)
        run: |
          # SRE Fix: use 'apply' on ConfigMaps to allow daily code updates
          kubectl create configmap ecommerce-logic --from-file=shop.jsp=src/shop.jsp -n devops-lab --dry-run=client -o yaml | kubectl apply -f -
          kubectl create configmap web-frontend --from-file=index.html=src/index.html -n devops-lab --dry-run=client -o yaml | kubectl apply -f -
          
          # Inject Nginx Proxy Config
          kubectl create configmap nginx-proxy-config --from-file=default.conf=k8s/nginx-config.yaml -n devops-lab --dry-run=client -o yaml | kubectl apply -f -

      - name: Rollout Updates (Restart Pods)
        run: |
          # Force pods to pick up the new ConfigMap AND the injected JDBC driver
          kubectl rollout restart deployment app-server -n devops-lab
          # Wait a few seconds to avoid throttling
          sleep 5
          kubectl rollout restart deployment web-server -n devops-lab

      - name: Final SRE Status Report
        run: |
          kubectl get pods,svc -n devops-lab
          echo "Lab is live at http://192.168.0.26:30088"
          echo "Grafana is live at http://192.168.0.26:32000"
